<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng K√Ω V√© Xe Th·∫≠p T·ª± Online</title>
    <style>
        :root { --primary-color: #d35400; --bg-color: #fdf5e6; --seat-avail: #fff; --seat-selected: #f1c40f; --seat-booked: #95a5a6; --seat-master: #c0392b; --warning-bg: #fff3cd; --warning-text: #856404; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 15px; border-radius: 10px; border-top: 5px solid var(--primary-color); position: relative;}
        
        h1 { text-align: center; color: var(--primary-color); margin: 5px 0; font-size: 1.5rem; }
        
        .program-img { width: 100%; max-height: 400px; object-fit: contain; border-radius: 5px; margin-bottom: 10px; display: none; }

        /* BUTTON STYLES */
        .btn { padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: #fff; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-info { background-color: #2980b9; margin-top: 0; width: auto; font-size: 14px; padding: 8px 15px; display: inline-block;} 
        
        .bus-tabs { display: flex; overflow-x: auto; gap: 5px; margin-bottom: 15px; padding-bottom: 5px; }
        .tab-btn { flex: 0 0 auto; padding: 8px 15px; border: 1px solid #ccc; background: #eee; cursor: pointer; border-radius: 15px; font-size: 13px; }
        .tab-btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }

        .bus-wrapper { background: #e0e0e0; padding: 20px; border-radius: 15px; margin: 0 auto; border: 2px solid #999; position: relative; }
        .bus-45 { width: 320px; } 
        .bus-16 { width: 220px; }

        .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .aisle { width: 30px; }
        
        .seat { 
            width: 45px; height: 35px; 
            background: var(--seat-avail); border: 1px solid #999; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 11px; font-weight: bold; cursor: pointer; user-select: none; 
        }
        .seat.selected { background-color: var(--seat-selected); color: #fff; border-color: #f39c12; }
        .seat.booked { background-color: var(--seat-booked); cursor: not-allowed; color: #fff; border-color: #7f8c8d; }
        .seat.master-seat { background-color: var(--seat-master); color: #fff; cursor: not-allowed; border-color: #922b21; }
        
        .driver-area { margin-top: 20px; border-top: 2px dashed #999; padding-top: 10px; display: flex; justify-content: space-between; font-weight: bold; color: #555; }
        
        .notice-box { background-color: var(--warning-bg); color: var(--warning-text); border: 1px solid #ffeeba; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 0.9rem; line-height: 1.4; text-align: justify; }
        .notice-box strong { color: #d35400; }

        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 5px rgba(211, 84, 0, 0.3); }
        
        #loading { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODAL CSS */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: #000; }
        .passenger-list-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .passenger-list-table th, .passenger-list-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; }
        .passenger-list-table th { background-color: var(--primary-color); color: white; text-align: center; }
        .passenger-list-table tr:nth-child(even){background-color: #f2f2f2;}
        
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>

    <h1>NAM M√î A DI ƒê√Ä PH·∫¨T</h1>
    <div style="text-align: center; margin-bottom: 10px; font-size: 0.9rem;">ƒêƒÉng K√Ω V√© Xe Th·∫≠p T·ª±</div>
    
    <img id="program-img" class="program-img" src="" alt="L·ªãch tr√¨nh">
    <div class="bus-tabs" id="bus-tabs"></div>

    <div class="notice-box">
        <strong>‚ö†Ô∏è L∆ØU √ù:</strong> Qu√Ω Ph·∫≠t T·ª≠ c√≤n tr·∫ª, kh√¥ng say xe vui l√≤ng ch·ªçn c√°c d√£y gh·∫ø ph√≠a d∆∞·ªõi, nh∆∞·ªùng c√°c gh·∫ø ƒë·∫ßu cho c√°c v·ªã l·ªõn tu·ªïi.<br>
        Gh·∫ø ƒë√£ ch·ªçn c√≥ th·ªÉ ƒë∆∞·ª£c B·ªïn T·ª± xem x√©t <strong>s·∫Øp x·∫øp l·∫°i</strong> cho ph√π h·ª£p. Mong Qu√Ω V·ªã hoan h·ª∑.
    </div>

    <div style="background: #fff3e0; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
        <input type="text" id="fullname" placeholder="H·ªç T√™n (B·∫Øt bu·ªôc)">
        <input type="text" id="phapdanh" placeholder="Ph√°p Danh">
        <input type="tel" id="birthyear" placeholder="NƒÉm Sinh (V√≠ d·ª•: 1960)" pattern="[0-9]*" maxlength="4">
        <input type="tel" id="phone" placeholder="S·ªë ƒêi·ªán Tho·∫°i (B·∫Øt bu·ªôc - 10 s·ªë)" pattern="[0-9]*" inputmode="numeric">
    </div>

    <div class="header-actions">
        <div style="font-size: 11px; display: flex; gap: 5px;">
            <span><span style="display:inline-block;width:10px;height:10px;background:#fff;border:1px solid #ccc"></span> Tr·ªëng</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:#f1c40f;"></span> Ch·ªçn</span>
            <span><span style="display:inline-block;width:10px;height:10px;background:#95a5a6;"></span> ƒê√£ ƒë·∫∑t</span>
        </div>
        <button class="btn btn-info" onclick="openPassengerList()">üìã Xem Danh S√°ch</button>
    </div>

    <div id="current-bus-map"></div>

    <div style="text-align: center; margin-top: 15px; background: #eee; padding: 10px; border-radius: 5px;">
        Gh·∫ø ch·ªçn: <strong id="selected-seats-display" style="color: #d35400;">...</strong>
    </div>

    <button class="btn btn-primary" onclick="submitBooking()">X√ÅC NH·∫¨N ƒêƒÇNG K√ù</button>
</div>

<div id="passengerModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closePassengerList()">&times;</span>
        <h3 style="text-align: center; color: var(--primary-color); margin-top: 0;">Danh S√°ch ƒê√£ ƒê·∫∑t</h3>
        <h4 id="modalBusName" style="text-align: center; margin: 5px 0;"></h4>
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="passenger-list-table" id="passengerTable">
                <thead>
                    <tr>
                        <th style="width: 30%">Gh·∫ø</th>
                        <th>H·ªç T√™n / Ph√°p Danh</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- B√ÅC D√ÅN LINK WEB APP C·ª¶A B√ÅC V√ÄO ƒê√ÇY ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw0Z6VYVzThkZ8XtKDe8gwZoaOi0b2pEaYhWiIt5KTaAm00ao0fhkX0njqhTSc3pmb_uw/exec"; 

    let buses = []; 
    let currentBusIndex = 0;
    let selectedSeats = [];
    let bookedData = [];

    const prioritySeats45 = ['1A','2A','3A','4A','5A','6A','7A','8A','1B','2B','3B','4B','5B','6B','7B','8B'];
    const prioritySeats16 = ['1','2','3','4','5','6','7','8','9','10','11','12'];

    window.onload = function() { 
        fetchData();
        setupEnterKey();
    };

    function setupEnterKey() {
        const inputs = ['fullname', 'phapdanh', 'birthyear', 'phone'];
        inputs.forEach((id, index) => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        if (index < inputs.length - 1) document.getElementById(inputs[index + 1]).focus();
                        else el.blur(); 
                    }
                });
            }
        });
    }

    async function fetchData() {
        document.getElementById('loading').style.display = 'flex';
        try {
            const noCacheUrl = SCRIPT_URL + "?t=" + new Date().getTime();
            const response = await fetch(noCacheUrl);
            const json = await response.json();
            
            if (json.status === 'success') {
                bookedData = json.data;
                buses = json.config.buses; 
                
                if (json.config.programImage) {
                    const imgEl = document.getElementById('program-img');
                    imgEl.src = json.config.programImage;
                    imgEl.style.display = 'block';
                }

                renderTabs();
                if(buses.length > 0) {
                    if (currentBusIndex >= buses.length) currentBusIndex = 0;
                    renderMap(currentBusIndex);
                }
            }
        } catch (error) { console.error(error); alert("L·ªói k·∫øt n·ªëi!"); } 
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    function renderTabs() {
        const container = document.getElementById('bus-tabs');
        container.innerHTML = '';
        buses.forEach((bus, index) => {
            const btn = document.createElement('div');
            btn.className = `tab-btn ${index === currentBusIndex ? 'active' : ''}`;
            btn.textContent = bus.name; 
            btn.onclick = () => {
                currentBusIndex = index;
                selectedSeats = []; 
                updateSummary();
                renderTabs();
                renderMap(index);
            };
            container.appendChild(btn);
        });
    }

    function renderMap(index) {
        const bus = buses[index];
        const container = document.getElementById('current-bus-map');
        container.innerHTML = '';
        
        const busWrapper = document.createElement('div');
        busWrapper.className = `bus-wrapper bus-${bus.type}`; 
        
        const booked = [];
        bookedData.forEach(b => { if(b.xe === bus.name) booked.push(...b.ghe); });

        const createSeat = (id, isRear=false) => {
            if (bus.type == '45' && id === '2A') return `<div class="seat master-seat">2A</div>`;
            
            let className = "seat";
            let onClick = `onclick="toggleSeat('${id}')"`;
            let content = id;

            if (booked.includes(id)) {
                className += " booked";
                onClick = ""; 
            } else if (selectedSeats.includes(id)) {
                className += " selected";
            }
            
            const style = isRear ? 'style="width:18%"' : '';
            return `<div class="${className}" ${style} ${onClick}>${content}</div>`;
        };

        let html = '';

        if (bus.type == '45') {
            html += `<div class="row">
                ${createSeat('41', true)}${createSeat('42', true)}${createSeat('43', true)}${createSeat('44', true)}${createSeat('45', true)}
            </div>`;
            const rows = [
                ['19A','20A','19B','20B'], ['17A','18A','17B','18B'], ['15A','16A','15B','16B'],
                ['13A','14A','13B','14B'], ['11A','12A','11B','12B'], ['9A','10A','9B','10B'],
                ['7A','8A','7B','8B'], ['5A','6A','5B','6B'], ['3A','4A','3B','4B'], ['1A','2A','1B','2B']
            ];
            rows.forEach(r => {
                html += `<div class="row">
                    <div style="display:flex; gap:5px">${createSeat(r[0])}${createSeat(r[1])}</div>
                    <div class="aisle"></div>
                    <div style="display:flex; gap:5px">${createSeat(r[2])}${createSeat(r[3])}</div>
                </div>`;
            });
        } else if (bus.type == '16') {
             html += `<div class="row">
                ${createSeat('13')}${createSeat('14')}${createSeat('15')}${createSeat('16')}
            </div>`;
            const rows16 = [['10','11','12'], ['7','8','9'], ['4','5','6'], ['1','2','3']];
            rows16.forEach(r => {
                html += `<div class="row">
                    <div style="display:flex; gap:5px">${createSeat(r[0])}${createSeat(r[1])}</div>
                    <div class="aisle"></div>
                    ${createSeat(r[2])}
                </div>`;
            });
        }
        html += `<div class="driver-area"><div>C·ª≠a</div><div>T√†i X·∫ø</div></div>`;
        busWrapper.innerHTML = html;
        container.appendChild(busWrapper);
    }

    function toggleSeat(id) {
        if (selectedSeats.includes(id)) {
            selectedSeats = selectedSeats.filter(s => s !== id);
            updateSummary();
            renderMap(currentBusIndex);
            return;
        }

        const bus = buses[currentBusIndex];
        let isPriority = false;
        if (bus.type == '45' && prioritySeats45.includes(id)) isPriority = true;
        if (bus.type == '16' && prioritySeats16.includes(id)) isPriority = true;

        if (isPriority) {
            const birthYearStr = document.getElementById('birthyear').value.trim();
            const currentYear = new Date().getFullYear();

            if (!birthYearStr) {
                alert("M√î PH·∫¨T! ƒê√¢y l√† d√£y gh·∫ø ∆∞u ti√™n (ng∆∞·ªùi >60 tu·ªïi).\nVui l√≤ng nh·∫≠p NƒÇM SINH ƒë·ªÉ x√°c nh·∫≠n.");
                document.getElementById('birthyear').focus();
                return;
            }
            const birthYear = parseInt(birthYearStr);
            if (isNaN(birthYear) || birthYear < 1900 || birthYear > currentYear) {
                alert("NƒÉm sinh kh√¥ng h·ª£p l·ªá."); return;
            }
            const age = currentYear - birthYear;
            if (age < 60) {
                alert(`M√î PH·∫¨T! Qu√Ω v·ªã ${age} tu·ªïi.\nD√£y gh·∫ø n√†y d√†nh cho c√°c v·ªã 60 tu·ªïi tr·ªü l√™n.\nXin qu√Ω v·ªã hoan h·ª∑ ch·ªçn c√°c d√£y gh·∫ø ph√≠a sau ·∫°.`);
                return;
            }
        }

        selectedSeats.push(id);
        updateSummary();
        renderMap(currentBusIndex);
    }

    function updateSummary() {
        document.getElementById('selected-seats-display').textContent = selectedSeats.length ? selectedSeats.join(', ') : "...";
    }

    async function submitBooking() {
        const name = document.getElementById('fullname').value.trim();
        const phone = document.getElementById('phone').value.trim();
        
        if (!name) return alert("M√î PH·∫¨T! Vui l√≤ng nh·∫≠p H·ªç T√™n.");
        const phoneRegex = /^0\d{9}$/;
        if (!phone || !phoneRegex.test(phone)) {
            alert("M√î PH·∫¨T! S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë√∫ng (ph·∫£i ƒë·ªß 10 s·ªë).");
            document.getElementById('phone').focus();
            return;
        }
        if (!selectedSeats.length) return alert("Ch∆∞a ch·ªçn gh·∫ø!");

        document.getElementById('loading').style.display = 'flex';
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    name, dharma: document.getElementById('phapdanh').value, phone,
                    busName: buses[currentBusIndex].name,
                    seats: selectedSeats
                })
            });
            const json = await res.json();
            if(json.status === 'success') {
                alert("M√î PH·∫¨T! ƒê√£ ƒêƒÉng k√Ω xong. Vui l√≤ng li√™n h·ªá VƒÉn Ph√≤ng ƒë·ªÉ nh·∫≠n v√©.");
                selectedSeats = [];
                document.getElementById('fullname').value = '';
                document.getElementById('phapdanh').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('birthyear').value = ''; 
                updateSummary();
                fetchData(); 
            } else {
                alert("L·ªñI: " + json.message);
                fetchData();
            }
        } catch (e) { alert("L·ªói g·ª≠i ƒë∆°n!"); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    // --- LOGIC CHO MODAL DANH S√ÅCH ---
    function openPassengerList() {
        const bus = buses[currentBusIndex];
        document.getElementById('modalBusName').textContent = bus.name;
        
        const tbody = document.querySelector('#passengerTable tbody');
        tbody.innerHTML = '';

        const passengers = [];
        bookedData.forEach(b => {
            if (b.xe === bus.name) {
                b.ghe.forEach(g => {
                    passengers.push({
                        seat: g,
                        name: b.ten,
                        dharma: b.phapdanh
                    });
                });
            }
        });

        // S·∫Øp x·∫øp theo T√äN (A->Z) ƒë·ªÉ gom nh√≥m gia ƒë√¨nh
        passengers.sort((a, b) => {
            return a.name.localeCompare(b.name, 'vi', {sensitivity: 'base'});
        });

        if (passengers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding: 20px;">Ch∆∞a c√≥ h√†nh kh√°ch n√†o ƒëƒÉng k√Ω.</td></tr>';
        } else {
            passengers.forEach(p => {
                const tr = document.createElement('tr');
                const displayName = (p.seat === '2A') ? "<strong>QU√ù TH·∫¶Y</strong>" : (p.dharma ? `${p.name} (${p.dharma})` : p.name);
                tr.innerHTML = `
                    <td style="text-align:center; font-weight:bold;">${p.seat}</td>
                    <td>${displayName}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        document.getElementById('passengerModal').style.display = "block";
    }

    function closePassengerList() {
        document.getElementById('passengerModal').style.display = "none";
    }

    window.onclick = function(event) {
        const modal = document.getElementById('passengerModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>

</body>
</html>